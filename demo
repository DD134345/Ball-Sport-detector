import cv2
import numpy as np
import tensorflow as tf
from tensorflow.keras.models import load_model
import tkinter as tk
from tkinter import filedialog
import os

# --- CONFIGURATION ---
MODEL_PATH = 'ball_classification.h5'
IMG_SIZE = (192, 192)  
TARGET_WIDTH = 1024  # <--- We will resize all images to this width for better detection

CLASS_LABELS = [
    'basketball', 
    'billiard_ball', 
    'bowling_ball', 
    'football', 
    'tennis_ball', 
    'volleyball'
]

def select_image():
    root = tk.Tk()
    root.withdraw()
    file_path = filedialog.askopenfilename(
        title="Select an Image of a Ball",
        filetypes=[("Image Files", "*.jpg *.jpeg *.png *.bmp *.webp")]
    )
    root.destroy()
    return file_path

def preprocess_for_model(roi, target_size):
    roi = cv2.resize(roi, target_size)
    roi = roi.astype('float32') / 255.0
    roi = np.expand_dims(roi, axis=0)
    return roi

def smart_resize(image, target_width):
    """
    Resizes image to a fixed width while maintaining aspect ratio.
    This helps standardize detection parameters.
    """
    (h, w) = image.shape[:2]
    
    # Calculate ratio to scale width to target_width
    r = target_width / float(w)
    dim = (target_width, int(h * r))
    
    # INTER_AREA is better for shrinking, INTER_CUBIC is better for enlarging
    if r < 1.0:
        interpolation = cv2.INTER_AREA
    else:
        interpolation = cv2.INTER_CUBIC
        
    resized = cv2.resize(image, dim, interpolation=interpolation)
    print(f"Original size: {w}x{h}, Resized to: {dim[0]}x{dim[1]}")
    return resized

def main():
    if not os.path.exists(MODEL_PATH):
        print(f"Error: Model file '{MODEL_PATH}' not found.")
        return

    try:
        model = load_model(MODEL_PATH)
    except Exception as e:
        print(f"Error loading model: {e}")
        return

    image_path = select_image()
    if not image_path: return
        
    image = cv2.imread(image_path)
    if image is None: return
    
    # --- NEW STEP: Smart Resize ---
    # This ensures the image is always big enough for the detector
    # but not so huge that it's slow or noisy.
    processing_image = smart_resize(image, TARGET_WIDTH)
    
    output_image = processing_image.copy()
    gray = cv2.cvtColor(processing_image, cv2.COLOR_BGR2GRAY)

    # Blur slightly to remove noise/texture (helps detection)
    gray = cv2.GaussianBlur(gray, (9, 9), 2)

    # Detect Balls
    circles = cv2.HoughCircles(
        gray, 
        cv2.HOUGH_GRADIENT, 
        dp=1.2, 
        minDist=50,       
        param1=50,        
        param2=30,        
        minRadius=20,     # Increased slightly since we upscaled the image
        maxRadius=400
    )

    if circles is not None:
        circles = np.round(circles[0, :]).astype("int")
        
        for (x, y, r) in circles:
            padding = 10
            y_min = max(0, y - r - padding)
            y_max = min(processing_image.shape[0], y + r + padding)
            x_min = max(0, x - r - padding)
            x_max = min(processing_image.shape[1], x + r + padding)

            roi = processing_image[y_min:y_max, x_min:x_max]
            if roi.size == 0: continue

            processed_roi = preprocess_for_model(roi, IMG_SIZE)
            predictions = model.predict(processed_roi, verbose=0)
            
            class_idx = np.argmax(predictions[0])
            confidence = predictions[0][class_idx]
            label = CLASS_LABELS[class_idx]

            if confidence > 0.4:
                # Draw on the RESIZED image
                cv2.rectangle(output_image, (x_min, y_min), (x_max, y_max), (0, 255, 0), 3)
                
                label_text = f"{label}: {confidence*100:.1f}%"
                (w, h), _ = cv2.getTextSize(label_text, cv2.FONT_HERSHEY_SIMPLEX, 0.6, 2)
                
                cv2.rectangle(output_image, (x_min, y_min - 25), (x_min + w, y_min), (0, 255, 0), -1)
                cv2.putText(output_image, label_text, (x_min, y_min - 5),
                            cv2.FONT_HERSHEY_SIMPLEX, 0.6, (0, 0, 0), 2)
                
                print(f"Detected: {label}")

    else:
        print("No balls detected.")
        cv2.putText(output_image, "No Ball Detected", (30, 30), 
                    cv2.FONT_HERSHEY_SIMPLEX, 1, (0, 0, 255), 2)

    cv2.imshow("Ball Detection Result", output_image)
    cv2.waitKey(0)
    cv2.destroyAllWindows()

if __name__ == "__main__":
    main()
